<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- PRIMARY SEO TAGS -->
    <title>Mystic Decision Tools | Spinning Wheel & Coin Flip</title>
    <meta
      name="description"
      content="The ultimate decision-making toolkit. Use the Mystic Spinning Wheel for multiple choices or the Cosmic Coin Flip for Yes/No decisions. Free, physics-based, and magical."
    />

    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Quicksand:wght@400;600&display=swap");

      body {
        font-family: "Quicksand", sans-serif;
        background-color: #0f172a;
        background-image: radial-gradient(
            at 0% 0%,
            rgba(76, 29, 149, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 0%,
            rgba(236, 72, 153, 0.3) 0px,
            transparent 50%
          ),
          radial-gradient(
            at 100% 100%,
            rgba(56, 189, 248, 0.3) 0px,
            transparent 50%
          );
        background-attachment: fixed;
        color: #e2e8f0;
        overflow-x: hidden;
      }

      h1,
      h2,
      h3,
      .magic-font {
        font-family: "Cinzel", serif;
      }

      .glass-panel {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
      }

      /* --- Mode Switcher Styles --- */
      .nav-btn {
        position: relative;
        transition: all 0.3s ease;
      }
      .nav-btn.active {
        color: #fff;
        background: rgba(139, 92, 246, 0.3);
        border-color: #a855f7;
        box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
      }
      .nav-btn.active::after {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: #a855f7;
        border-radius: 50%;
        box-shadow: 0 0 10px #a855f7;
      }

      /* --- COIN STYLES (Vertical Flip) --- */
      .coin-wrapper {
        perspective: 1000px;
        width: 200px;
        height: 200px;
        margin: 0 auto;
      }

      .coin {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .coin-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        border: 4px solid #fbbf24;
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.4),
          inset 0 0 20px rgba(0, 0, 0, 0.5);
      }

      /* Front: Sun / Heads */
      .coin-front {
        background: radial-gradient(circle at 30% 30%, #fcd34d, #b45309);
        color: #78350f;
        transform: rotateX(0deg); /* Starting position */
      }

      /* Back: Moon / Tails */
      .coin-back {
        background: radial-gradient(circle at 30% 30%, #94a3b8, #334155);
        color: #e2e8f0;
        border-color: #94a3b8;
        transform: rotateX(180deg); /* Starting position (flipped vertically) */
      }

      /* --- Utility --- */
      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Standard Magic Button */
      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }
        50% {
          box-shadow: 0 0 25px rgba(139, 92, 246, 0.8),
            0 0 5px rgba(255, 255, 255, 0.5);
        }
      }
      .btn-magic {
        background: linear-gradient(45deg, #7c3aed, #db2777);
        transition: all 0.3s ease;
        animation: pulse-glow 3s infinite;
      }
      .btn-magic:hover {
        transform: scale(1.02) translateY(-1px);
        filter: brightness(1.2);
      }
      .btn-magic:active {
        transform: scale(0.98);
      }

      /* Wheel specifics */
      #canvas-container {
        filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.3));
      }
      .choice-chip {
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #a855f7;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #a855f7;
      }
      .pointer-wrapper {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.5));
        transform-origin: 50% 20px;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col items-center py-6 px-4">
    <!-- Header & Nav -->
    <header class="text-center mb-6 relative z-10 w-full max-w-xl">
      <h1
        class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-cyan-400 mb-4"
        style="text-shadow: 0 0 30px rgba(168, 85, 247, 0.4)"
      >
        Mystic Tools
      </h1>

      <div
        class="glass-panel p-1 rounded-xl flex justify-between gap-2 relative"
      >
        <button
          id="tab-wheel"
          class="nav-btn active flex-1 py-2 rounded-lg text-slate-300 font-bold magic-font text-sm md:text-base hover:bg-white/5 border border-transparent cursor-pointer"
        >
          <i class="fas fa-chart-pie mr-2"></i>Wheel
        </button>
        <button
          id="tab-coin"
          class="nav-btn flex-1 py-2 rounded-lg text-slate-300 font-bold magic-font text-sm md:text-base hover:bg-white/5 border border-transparent cursor-pointer"
        >
          <i class="fas fa-coins mr-2"></i>Coin Flip
        </button>
      </div>
    </header>

    <!-- ==================== VIEW: WHEEL ==================== -->
    <main
      id="view-wheel"
      class="w-full max-w-6xl flex flex-col lg:flex-row gap-8 items-start justify-center flex-grow fade-in"
    >
      <div
        class="glass-panel rounded-2xl p-6 w-full lg:w-1/3 flex flex-col gap-4 min-h-[500px]"
      >
        <div class="flex gap-2 justify-center mb-2 overflow-x-auto pb-2">
          <button
            class="preset-btn px-3 py-1 text-xs rounded-full bg-slate-700 hover:bg-purple-600 transition text-white border border-slate-600 whitespace-nowrap"
            data-type="food"
          >
            üçî Food
          </button>
          <button
            class="preset-btn px-3 py-1 text-xs rounded-full bg-slate-700 hover:bg-purple-600 transition text-white border border-slate-600 whitespace-nowrap"
            data-type="yesno"
          >
            üîÆ Yes/No
          </button>
          <button
            class="preset-btn px-3 py-1 text-xs rounded-full bg-slate-700 hover:bg-purple-600 transition text-white border border-slate-600 whitespace-nowrap"
            data-type="dice"
          >
            üé≤ D20
          </button>
          <button
            class="preset-btn px-3 py-1 text-xs rounded-full bg-slate-700 hover:bg-purple-600 transition text-white border border-slate-600 whitespace-nowrap"
            data-type="activity"
          >
            üèÉ Activity
          </button>
        </div>

        <div class="relative">
          <input
            type="text"
            id="new-choice"
            class="w-full bg-slate-800/50 border border-slate-600 rounded-xl p-4 pr-12 text-white focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all font-bold"
            placeholder="Type & Enter..."
          />
          <button
            id="btn-add"
            class="absolute right-2 top-2 bottom-2 px-3 text-purple-400 hover:text-white hover:bg-purple-600 rounded-lg transition"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>

        <div
          id="choice-list"
          class="flex-grow overflow-y-auto max-h-[300px] flex flex-wrap content-start gap-2 p-2 bg-slate-900/30 rounded-xl border border-white/5"
        ></div>

        <div
          class="flex items-center justify-between bg-slate-800/40 p-3 rounded-lg"
        >
          <span class="text-sm text-slate-300"
            ><i class="fas fa-skull mr-2"></i>Battle Royale</span
          >
          <div
            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
          >
            <input
              type="checkbox"
              id="battle-mode"
              class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
            />
            <label
              for="battle-mode"
              class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"
            ></label>
          </div>
        </div>

        <div class="flex gap-2 mt-auto pt-4">
          <button
            id="btn-clear"
            class="px-4 py-3 rounded-lg border border-slate-500 hover:bg-red-500/20 hover:border-red-400 text-slate-300 hover:text-red-200 transition-colors"
          >
            <i class="fas fa-trash"></i>
          </button>
          <button
            id="spin-btn"
            class="btn-magic flex-grow py-3 rounded-lg font-bold text-white text-lg tracking-wider uppercase shadow-lg flex items-center justify-center gap-2"
          >
            <span>Cast to Fate</span><i class="fas fa-sparkles"></i>
          </button>
        </div>
      </div>

      <div
        class="relative flex-grow flex flex-col justify-center items-center p-4"
        id="canvas-container"
      >
        <div class="pointer-wrapper" id="pointer">
          <svg
            width="50"
            height="60"
            viewBox="0 0 40 50"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <defs>
              <linearGradient id="goldGrad" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#FDE68A" />
                <stop offset="50%" stop-color="#D97706" />
                <stop offset="100%" stop-color="#92400E" />
              </linearGradient>
            </defs>
            <path
              d="M20 55L5 15L20 0L35 15L20 55Z"
              fill="url(#goldGrad)"
              stroke="#78350F"
              stroke-width="1.5"
            />
            <circle
              cx="20"
              cy="15"
              r="6"
              fill="#451a03"
              stroke="#FBBF24"
              stroke-width="2"
            />
            <circle cx="20" cy="15" r="2" fill="#FBBF24" />
          </svg>
        </div>
        <canvas
          id="wheel"
          width="600"
          height="600"
          class="max-w-full h-auto"
        ></canvas>
      </div>
    </main>

    <!-- ==================== VIEW: COIN ==================== -->
    <main
      id="view-coin"
      class="hidden w-full max-w-lg flex flex-col items-center justify-center flex-grow fade-in py-4 lg:py-12"
    >
      <div
        class="glass-panel p-8 rounded-3xl w-full text-center relative overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-full bg-purple-500/10 blur-3xl pointer-events-none"
        ></div>
        <h2 class="magic-font text-2xl text-purple-200 mb-6">
          The Coin of Destiny
        </h2>

        <!-- Custom Labels Inputs -->
        <div class="flex gap-4 mb-8 justify-center">
          <div class="flex flex-col text-left w-1/2">
            <label class="text-xs text-amber-300 mb-1 font-bold ml-1"
              >SIDE A (SUN)</label
            >
            <input
              type="text"
              id="input-heads"
              value="Heads"
              class="bg-slate-800/80 border border-amber-500/30 rounded-lg px-3 py-2 text-sm text-white focus:border-amber-500 focus:outline-none"
            />
          </div>
          <div class="flex flex-col text-left w-1/2">
            <label class="text-xs text-slate-400 mb-1 font-bold ml-1"
              >SIDE B (MOON)</label
            >
            <input
              type="text"
              id="input-tails"
              value="Tails"
              class="bg-slate-800/80 border border-slate-500/30 rounded-lg px-3 py-2 text-sm text-white focus:border-slate-400 focus:outline-none"
            />
          </div>
        </div>

        <!-- 3D Coin -->
        <div class="coin-wrapper mb-10">
          <div id="coin" class="coin">
            <div class="coin-face coin-front">
              <i class="fas fa-sun text-4xl"></i>
            </div>
            <div class="coin-face coin-back">
              <i class="fas fa-moon text-4xl"></i>
            </div>
          </div>
        </div>

        <button
          id="flip-btn"
          class="btn-magic w-full py-4 rounded-xl font-bold text-white text-xl tracking-wider uppercase shadow-lg mb-6"
        >
          Flip Coin
        </button>
        <div
          id="coin-result"
          class="h-12 text-3xl font-bold text-white magic-font transition-opacity opacity-0"
        >
          Heads
        </div>
      </div>
    </main>

    <!-- Footer -->
    <section
      class="max-w-4xl mx-auto mt-12 mb-8 px-6 text-center text-slate-400"
    >
      <p class="text-xs opacity-50">Crafted with Stardust & Code.</p>
    </section>

    <!-- Result Modal -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-500"
    >
      <div
        class="glass-panel p-8 rounded-2xl text-center max-w-md mx-4 transform scale-90 transition-transform duration-500 border-t-4 border-purple-500"
        id="result-content"
      >
        <h2 class="text-xl text-purple-300 mb-2 magic-font tracking-widest">
          DESTINY CHOSEN
        </h2>
        <div
          id="winner-text"
          class="text-4xl md:text-5xl font-bold text-white my-8 drop-shadow-[0_0_15px_rgba(168,85,247,0.8)] break-words"
        >
          Result
        </div>
        <button
          id="btn-close-modal"
          class="bg-white text-purple-900 hover:bg-purple-100 font-bold px-10 py-3 rounded-full transition-all transform hover:scale-105 shadow-lg"
        >
          Accept
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Global State ---
        let audioCtx = null;
        function initAudio() {
          try {
            if (!audioCtx)
              audioCtx = new (window.AudioContext ||
                window.webkitAudioContext)();
          } catch (e) {}
        }

        // --- Elements ---
        const tabWheel = document.getElementById("tab-wheel");
        const tabCoin = document.getElementById("tab-coin");
        const wheelView = document.getElementById("view-wheel");
        const coinView = document.getElementById("view-coin");

        const input = document.getElementById("new-choice");
        const listContainer = document.getElementById("choice-list");
        const btnAdd = document.getElementById("btn-add");
        const btnClear = document.getElementById("btn-clear");
        const spinBtn = document.getElementById("spin-btn");
        const canvas = document.getElementById("wheel");
        const ctx = canvas ? canvas.getContext("2d") : null;
        const battleMode = document.getElementById("battle-mode");
        const pointer = document.getElementById("pointer");

        const modal = document.getElementById("result-modal");
        const modalContent = document.getElementById("result-content");
        const winnerText = document.getElementById("winner-text");
        const btnCloseModal = document.getElementById("btn-close-modal");

        const coinEl = document.getElementById("coin");
        const coinResultEl = document.getElementById("coin-result");
        const flipBtn = document.getElementById("flip-btn");
        const inputHeads = document.getElementById("input-heads");
        const inputTails = document.getElementById("input-tails");

        // --- NAVIGATION LOGIC ---
        function switchMode(mode) {
          if (mode === "wheel") {
            wheelView.classList.remove("hidden");
            coinView.classList.add("hidden");
            tabWheel.classList.add("active");
            tabCoin.classList.remove("active");
            resizeCanvas();
          } else {
            wheelView.classList.add("hidden");
            coinView.classList.remove("hidden");
            tabWheel.classList.remove("active");
            tabCoin.classList.add("active");
          }
        }
        if (tabWheel)
          tabWheel.addEventListener("click", () => switchMode("wheel"));
        if (tabCoin)
          tabCoin.addEventListener("click", () => switchMode("coin"));

        // --- COIN FLIP LOGIC (Vertical) ---
        let coinRotation = 0;
        let isFlipping = false;

        function playCoinSound() {
          if (!audioCtx) return;
          const now = audioCtx.currentTime;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = "sine";
          osc.frequency.setValueAtTime(2000, now);
          osc.frequency.exponentialRampToValueAtTime(100, now + 0.5);
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(now + 0.6);
        }

        function flipCoin() {
          if (isFlipping) return;
          initAudio();
          isFlipping = true;
          flipBtn.disabled = true;
          flipBtn.classList.add("opacity-50");
          coinResultEl.classList.remove("opacity-100");
          coinResultEl.classList.add("opacity-0");

          playCoinSound();

          const result = Math.random() < 0.5 ? "heads" : "tails";

          // ROTATE X for vertical spin
          const baseSpins = 1800; // 5 full rotations
          const targetAngle = result === "heads" ? 0 : 180;

          let nextRotation = coinRotation + baseSpins;
          const mod = nextRotation % 360;
          let adjustment = targetAngle - mod;
          if (adjustment < 0) adjustment += 360;

          coinRotation = nextRotation + adjustment;
          coinEl.style.transform = `rotateX(${coinRotation}deg)`;

          setTimeout(() => {
            isFlipping = false;
            flipBtn.disabled = false;
            flipBtn.classList.remove("opacity-50");

            const valHeads = inputHeads.value || "Heads";
            const valTails = inputTails.value || "Tails";

            coinResultEl.innerText = result === "heads" ? valHeads : valTails;
            coinResultEl.classList.remove("opacity-0");
            coinResultEl.classList.add("opacity-100");

            if (audioCtx) {
              const osc = audioCtx.createOscillator();
              const gain = audioCtx.createGain();
              osc.frequency.setValueAtTime(
                result === "heads" ? 880 : 600,
                audioCtx.currentTime
              );
              gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
              gain.gain.exponentialRampToValueAtTime(
                0.001,
                audioCtx.currentTime + 0.3
              );
              osc.connect(gain);
              gain.connect(audioCtx.destination);
              osc.start();
              osc.stop(audioCtx.currentTime + 0.3);
            }
          }, 3000);
        }
        if (flipBtn) flipBtn.addEventListener("click", flipCoin);

        // --- WHEEL LOGIC ---
        const colors = [
          "#C026D3",
          "#4F46E5",
          "#0891B2",
          "#059669",
          "#D97706",
          "#E11D48",
          "#7C3AED",
        ];
        let items = ["Pizza", "Sushi", "Tacos", "Burgers"];
        let currentAngle = 0;
        let isSpinning = false;
        let spinVelocity = 0;
        let spinDeceleration = 0.99;
        let lastSegmentIndex = -1;
        let pointerAngle = 0;

        function resizeCanvas() {
          // Can add DPI adjustments here if needed
        }

        listContainer.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const chip = btn.closest(".choice-chip");
          const index = Array.from(listContainer.children).indexOf(chip);
          if (index > -1) removeChoice(index);
        });

        function addChoice() {
          const val = input.value.trim();
          if (val) {
            items.push(val);
            input.value = "";
            renderList();
            drawWheel();
            playPopSound();
          }
          input.focus();
        }

        function removeChoice(index) {
          if (isSpinning) return;
          items.splice(index, 1);
          renderList();
          drawWheel();
        }

        function clearChoices() {
          if (isSpinning) return;
          items = [];
          renderList();
          drawWheel();
        }

        function loadPreset(type) {
          if (isSpinning) return;
          if (type === "food")
            items = [
              "Pizza",
              "Sushi",
              "Burgers",
              "Salad",
              "Tacos",
              "Pasta",
              "Curry",
            ];
          if (type === "yesno") items = ["Yes", "No", "Definitely", "Nope"];
          if (type === "dice")
            items = Array.from({ length: 20 }, (_, i) => (i + 1).toString());
          if (type === "activity")
            items = [
              "Watch a Movie",
              "Read a Book",
              "Go for a Walk",
              "Code",
              "Sleep",
              "Clean Room",
            ];
          renderList();
          drawWheel();
        }

        if (input)
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") addChoice();
          });
        if (btnAdd) btnAdd.addEventListener("click", addChoice);
        if (btnClear) btnClear.addEventListener("click", clearChoices);
        if (spinBtn) spinBtn.addEventListener("click", startSpin);

        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", () => loadPreset(btn.dataset.type));
        });

        function closeModal() {
          modal.classList.add("opacity-0");
          modalContent.classList.add("scale-90");
          setTimeout(() => {
            modal.classList.add("hidden");
          }, 500);
        }
        if (btnCloseModal) btnCloseModal.addEventListener("click", closeModal);

        function renderList() {
          listContainer.innerHTML = "";
          if (items.length === 0) {
            listContainer.innerHTML =
              '<p class="text-slate-500 text-center w-full mt-4 italic">The void is empty...</p>';
            return;
          }
          items.forEach((item, index) => {
            const chip = document.createElement("div");
            chip.className =
              "choice-chip bg-slate-700 text-white px-3 py-1 rounded-full flex items-center gap-2 text-sm border border-slate-600 shadow-sm";
            chip.innerHTML = `<span>${item}</span><button class="text-slate-400 hover:text-red-400 transition"><i class="fas fa-times pointer-events-none"></i></button>`;
            listContainer.appendChild(chip);
          });
        }

        function playPopSound() {
          if (!audioCtx) return;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.frequency.setValueAtTime(600, audioCtx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(
            100,
            audioCtx.currentTime + 0.1
          );
          gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + 0.1
          );
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.1);
        }

        function playTick() {
          if (!audioCtx) return;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = "square";
          osc.frequency.setValueAtTime(150, audioCtx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(
            40,
            audioCtx.currentTime + 0.03
          );
          gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + 0.03
          );
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.05);
        }

        function playWinSound() {
          if (!audioCtx) return;
          const now = audioCtx.currentTime;
          const notes = [523.25, 659.25, 783.99, 1046.5, 1318.51];
          notes.forEach((freq, i) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = "sine";
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now + i * 0.05);
            gain.gain.linearRampToValueAtTime(0.2, now + 0.1 + i * 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(now + 3);
          });
        }

        function drawWheel() {
          if (!ctx) return;
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const radius = 280;
          const drawItems = items.length > 0 ? items : ["?"];
          const arcSize = (2 * Math.PI) / drawItems.length;

          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.shadowBlur = 25;
          ctx.shadowColor = "#a855f7";
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius + 8, 0, 2 * Math.PI);
          ctx.fillStyle = "#1e293b";
          ctx.fill();
          ctx.strokeStyle = "#fbbf24";
          ctx.lineWidth = 8;
          ctx.stroke();
          ctx.restore();

          drawItems.forEach((item, index) => {
            const startAngle = currentAngle + index * arcSize;
            const endAngle = startAngle + arcSize;
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            ctx.fillStyle = colors[index % colors.length];
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.stroke();
            ctx.translate(centerX, centerY);
            ctx.rotate(startAngle + arcSize / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = "#fff";
            ctx.font = "bold 24px Quicksand";
            ctx.shadowColor = "rgba(0,0,0,0.8)";
            ctx.shadowBlur = 4;
            let text = item;
            if (text.length > 18) text = text.substring(0, 16) + "...";
            ctx.fillText(text, radius - 30, 8);
            ctx.restore();
          });

          ctx.beginPath();
          ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
          ctx.fillStyle = "#f59e0b";
          ctx.fill();
          ctx.beginPath();
          ctx.arc(centerX, centerY, 32, 0, 2 * Math.PI);
          ctx.fillStyle = "#1e293b";
          ctx.fill();
          ctx.beginPath();
          ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
          ctx.fillStyle = "#d946ef";
          ctx.shadowColor = "#d946ef";
          ctx.shadowBlur = 15;
          ctx.fill();
          ctx.shadowBlur = 0;
        }

        function startSpin() {
          if (isSpinning) return;
          if (items.length === 0) {
            input.focus();
            playPopSound();
            return;
          }
          initAudio();
          isSpinning = true;
          spinBtn.classList.add("opacity-50", "cursor-not-allowed");
          input.disabled = true;
          spinVelocity = Math.random() * 0.3 + 0.5;
          lastSegmentIndex = -1;
        }

        function loop() {
          if (isSpinning) {
            currentAngle += spinVelocity;
            spinVelocity *= spinDeceleration;
            if (currentAngle >= Math.PI * 2) currentAngle -= Math.PI * 2;

            const numSegments = items.length || 1;
            const arcSize = (Math.PI * 2) / numSegments;
            const rotation = currentAngle % (Math.PI * 2);
            const pointerTheta = (3 * Math.PI) / 2 - rotation;

            let normalizedTheta = pointerTheta;
            while (normalizedTheta < 0) normalizedTheta += Math.PI * 2;
            while (normalizedTheta >= Math.PI * 2)
              normalizedTheta -= Math.PI * 2;

            const currentIndex = Math.floor(normalizedTheta / arcSize);

            if (currentIndex !== lastSegmentIndex && spinVelocity > 0.01) {
              playTick();
              lastSegmentIndex = currentIndex;
              pointerAngle = -25;
            }
            if (spinVelocity < 0.0015) {
              isSpinning = false;
              spinVelocity = 0;
              finishSpin(currentIndex);
            }
          }
          pointerAngle *= 0.9;
          pointer.style.transform = `translateX(-50%) rotate(${pointerAngle}deg)`;
          drawWheel();
          updateAndDrawParticles();
          requestAnimationFrame(loop);
        }

        function finishSpin(winnerIndex) {
          input.disabled = false;
          spinBtn.classList.remove("opacity-50", "cursor-not-allowed");
          const winner = items[winnerIndex];
          if (battleMode.checked) {
            items.splice(winnerIndex, 1);
            renderList();
          }
          playWinSound();
          spawnParticles();
          setTimeout(() => {
            winnerText.innerText = winner;
            modal.classList.remove("hidden");
            void modal.offsetWidth;
            modal.classList.remove("opacity-0");
            modalContent.classList.remove("scale-90");
          }, 500);
        }

        let particles = [];
        const particleColors = ["#F472B6", "#A78BFA", "#34D399", "#FBBF24"];
        class Particle {
          constructor(x, y) {
            this.x = x;
            this.y = y;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 6 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.decay = Math.random() * 0.01 + 0.01;
            this.color =
              particleColors[Math.floor(Math.random() * particleColors.length)];
            this.size = Math.random() * 4 + 2;
          }
          update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= this.decay;
            this.vy += 0.15;
            this.vx *= 0.95;
          }
          draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.rect(this.x, this.y, this.size, this.size);
            ctx.fill();
            ctx.globalAlpha = 1.0;
          }
        }
        function spawnParticles() {
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          for (let i = 0; i < 80; i++)
            particles.push(new Particle(centerX, centerY - 150));
        }
        function updateAndDrawParticles() {
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.update();
            p.draw(ctx);
            if (p.life <= 0) particles.splice(i, 1);
          }
        }

        // Init
        if (canvas) {
          renderList();
          drawWheel();
          loop();
          resizeCanvas();
          window.addEventListener("resize", resizeCanvas);
        }
      });
    </script>
  </body>
</html>
